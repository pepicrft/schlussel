#!/usr/bin/env bash
#MISE description="Build the library for all platforms"
set -euo pipefail

# Cross-platform build script for Schlussel
# Builds static and shared libraries for common platforms using Rust

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
BUILD_DIR="$PROJECT_ROOT/dist"

echo "Building Schlussel for multiple platforms..."
echo "============================================"
echo ""

# Clean previous builds
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"

# Define target platforms
# Format: "rust-target:output-dir"
TARGETS=(
    "x86_64-unknown-linux-gnu:linux-x86_64"
    "aarch64-unknown-linux-gnu:linux-aarch64"
    "x86_64-apple-darwin:macos-x86_64"
    "aarch64-apple-darwin:macos-aarch64"
    "x86_64-pc-windows-gnu:windows-x86_64"
    "aarch64-pc-windows-gnu:windows-aarch64"
)

build_for_target() {
    local target=$1
    local output_dir=$2

    echo "Building for $output_dir (target: $target)..."

    local target_dir="$BUILD_DIR/$output_dir"
    mkdir -p "$target_dir"

    # Add target if not installed
    rustup target add "$target" 2>/dev/null || true

    # Build static and shared libraries
    cargo build --release --target "$target"

    if [ $? -eq 0 ]; then
        echo "  ✓ Build successful for $output_dir"

        # Copy libraries to dist
        mkdir -p "$target_dir/lib"
        cp target/"$target"/release/libschlussel.* "$target_dir/lib/" 2>/dev/null || true

        # List generated files
        echo "  Generated files:"
        find "$target_dir" -type f | sed 's|^|    |'
    else
        echo "  ✗ Build failed for $output_dir"
        return 1
    fi

    echo ""
}

# Build for each target
for target_spec in "${TARGETS[@]}"; do
    IFS=':' read -r target output_dir <<< "$target_spec"
    build_for_target "$target" "$output_dir" || echo "Warning: Build failed for $output_dir"
done

# Copy include files
mkdir -p "$BUILD_DIR/include"
cp include/schlussel.h "$BUILD_DIR/include/" 2>/dev/null || true

echo "============================================"
echo "Cross-platform build complete!"
echo ""
echo "Build artifacts are in: $BUILD_DIR"
echo ""
echo "To use the library:"
echo "  - Include: $BUILD_DIR/include/schlussel.h"
echo "  - Link against the appropriate library for your platform"
echo ""
